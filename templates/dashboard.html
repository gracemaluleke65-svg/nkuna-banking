{% extends "base.html" %}

{% block title %}Dashboard - Nkuna Banking{% endblock %}

{% block head %}
<style>
    .dashboard-hero {
        background: linear-gradient(135deg, #0066CC 0%, #0047AB 100%);
        border-radius: 20px;
        padding: 40px;
        color: white;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }
    
    .dashboard-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .balance-display {
        font-family: 'Poppins', sans-serif;
        font-weight: 800;
        font-size: 3.5rem;
        background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
        margin-bottom: 10px;
    }
    
    .quick-action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .quick-action-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-decoration: none;
        color: inherit;
        display: block;
        position: relative;
        overflow: hidden;
        z-index: 1;
    }
    
    .quick-action-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(0, 102, 204, 0.05) 0%, rgba(0, 212, 170, 0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: -1;
    }
    
    .quick-action-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        text-decoration: none;
        color: inherit;
    }
    
    .quick-action-card:hover::before {
        opacity: 1;
    }
    
    .action-icon {
        width: 70px;
        height: 70px;
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 28px;
        color: white;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }
    
    .quick-action-card:hover .action-icon {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
    }
    
    .deposit-icon { background: linear-gradient(135deg, #0066CC 0%, #0047AB 100%); }
    .transfer-icon { background: linear-gradient(135deg, #00D4AA 0%, #009688 100%); }
    .utilities-icon { background: linear-gradient(135deg, #FF6B6B 0%, #EE5A24 100%); }
    .goals-icon { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
    
    .transaction-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .transaction-card:hover {
        transform: translateX(5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .transaction-incoming {
        border-left-color: #00D4AA;
    }
    
    .transaction-outgoing {
        border-left-color: #FF6B6B;
    }
    
    .transaction-amount {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 1.3rem;
    }
    
    .undo-btn {
        background: linear-gradient(135deg, #FFEAA7 0%, #FDCB6E 100%);
        border: none;
        color: #2d3748;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .undo-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(253, 203, 110, 0.4);
    }
    
    .goal-progress-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 25px;
        color: white;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .goal-progress-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .progress-bar-container {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        height: 10px;
        margin: 15px 0;
        overflow: hidden;
    }
    
    .progress-bar {
        height: 100%;
        background: white;
        border-radius: 10px;
        transition: width 1s ease;
    }
    
    .security-card {
        background: linear-gradient(135deg, #FFEAA7 0%, #FDCB6E 100%);
        border-radius: 16px;
        padding: 25px;
        color: #2d3748;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        color: #e2e8f0;
        margin-bottom: 20px;
    }
    
    .stats-badge {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        color: white;
        margin-top: 20px;
    }
    
    .stats-number {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    
    .stats-label {
        font-size: 0.85rem;
        opacity: 0.9;
    }
    
    .add-money-btn {
        background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .add-money-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        color: white;
        text-decoration: none;
    }
    
    @media (max-width: 768px) {
        .dashboard-hero {
            padding: 25px;
            border-radius: 16px;
        }
        
        .balance-display {
            font-size: 2.5rem;
        }
        
        .quick-action-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .action-icon {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }
        
        .transaction-card {
            padding: 20px;
        }
        
        .add-money-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Welcome Section -->
<div class="dashboard-hero">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="mb-2">Welcome back, <strong>{{ user.full_name }}</strong>!</h1>
            <p class="opacity-90 mb-4">Your account is secure and ready for banking</p>
            
            <div class="d-flex align-items-center">
                <div class="me-4">
                    <div class="text-white opacity-80 mb-1">Account Number</div>
                    <div class="h4 mb-0">{{ user.account_number }}</div>
                </div>
                <div>
                    <div class="text-white opacity-80 mb-1">Member Since</div>
                    <div class="h5 mb-0">{{ user.created_at.strftime('%b %Y') }}</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 text-md-end mt-4 mt-md-0">
            <div class="text-white opacity-80 mb-1">Available Balance</div>
            <div class="balance-display">{{ format_currency(user.balance) }}</div>
            <div class="d-flex justify-content-md-end gap-2 mt-3">
                <!-- FIXED: Add Money button with correct URL -->
              
               
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<h3 class="mb-3">Quick Actions</h3>
<div class="quick-action-grid">
    <a href="{{ url_for('user.deposit') }}" class="quick-action-card">
        <div class="action-icon deposit-icon">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <h4 class="mb-2">Deposit</h4>
        <p class="text-muted small mb-0">Add money to your account instantly</p>
        <div class="mt-3 text-primary small">
            Min: R10 • Max: R50,000 <i class="fas fa-arrow-right ms-1"></i>
        </div>
    </a>
    
    <a href="{{ url_for('user.transfer') }}" class="quick-action-card">
        <div class="action-icon transfer-icon">
            <i class="fas fa-share"></i>
        </div>
        <h4 class="mb-2">Transfer</h4>
        <p class="text-muted small mb-0">Send money to other accounts</p>
        <div class="mt-3 text-success small">
            1% Fee • 15-min undo <i class="fas fa-arrow-right ms-1"></i>
        </div>
    </a>
    
    <a href="{{ url_for('user.utilities') }}" class="quick-action-card">
        <div class="action-icon utilities-icon">
            <i class="fas fa-bolt"></i>
        </div>
        <h4 class="mb-2">Utilities</h4>
        <p class="text-muted small mb-0">Pay bills, airtime & data</p>
        <div class="mt-3 text-warning small">
            R5 Fixed Fee <i class="fas fa-arrow-right ms-1"></i>
        </div>
    </a>
    
    <a href="{{ url_for('user.goals') }}" class="quick-action-card">
        <div class="action-icon goals-icon">
            <i class="fas fa-bullseye"></i>
        </div>
        <h4 class="mb-2">Goals</h4>
        <p class="text-muted small mb-0">Save for your dreams</p>
        <div class="mt-3 text-purple small">
            {{ active_goals|length }} Active Goals <i class="fas fa-arrow-right ms-1"></i>
        </div>
    </a>
</div>

<div class="row">
    <!-- Recent Transactions -->
    <div class="col-lg-8 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Recent Transactions</h3>
            <a href="{{ url_for('user.history') }}" class="btn btn-outline-primary">
                <i class="fas fa-history me-1"></i> View All
            </a>
        </div>
        
        {% if recent_transactions %}
            <div class="transaction-list">
                {% for transaction in recent_transactions %}
                <div class="transaction-card {% if transaction.is_incoming() %}transaction-incoming{% else %}transaction-outgoing{% endif %}">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    {% if transaction.transaction_type == 'deposit' %}
                                    <div class="bg-success rounded-circle p-2 text-white" style="width: 40px; height: 40px;">
                                        <i class="fas fa-download"></i>
                                    </div>
                                    {% elif transaction.transaction_type == 'transfer' %}
                                    <div class="bg-primary rounded-circle p-2 text-white" style="width: 40px; height: 40px;">
                                        <i class="fas fa-exchange-alt"></i>
                                    </div>
                                    {% elif transaction.transaction_type == 'utility' %}
                                    <div class="bg-warning rounded-circle p-2 text-white" style="width: 40px; height: 40px;">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    {% elif transaction.transaction_type == 'goal_deposit' %}
                                    <div class="bg-purple rounded-circle p-2 text-white" style="width: 40px; height: 40px;">
                                        <i class="fas fa-piggy-bank"></i>
                                    </div>
                                    {% else %}
                                    <div class="bg-info rounded-circle p-2 text-white" style="width: 40px; height: 40px;">
                                        <i class="fas fa-receipt"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <h6 class="mb-1">{{ transaction.get_description() }}</h6>
                                    <small class="text-muted">
                                        <i class="far fa-clock me-1"></i>
                                        {{ format_datetime(transaction.created_at) }}
                                        {% if transaction.transaction_type == 'transfer' %}
                                            {% if transaction.is_sender %}
                                                <span class="ms-2"><i class="fas fa-paper-plane me-1"></i>To: {{ transaction.recipient_name }}</span>
                                            {% else %}
                                                <span class="ms-2"><i class="fas fa-inbox me-1"></i>From: {{ transaction.sender_name }}</span>
                                            {% endif %}
                                        {% endif %}
                                    </small>
                                    {% if transaction.admin_fee > 0 %}
                                    <div class="text-muted small mt-1">
                                        <i class="fas fa-percentage"></i> Fee: {{ format_currency(transaction.admin_fee) }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 text-md-center mb-3 mb-md-0">
                            <div class="transaction-amount {% if transaction.is_incoming() %}text-success{% else %}text-danger{% endif %}">
                                {{ transaction.get_amount_display() }}
                            </div>
                            {% if transaction.status == 'reversed' %}
                            <span class="badge bg-secondary">Reversed</span>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-2 text-md-end">
                            {% if transaction.can_be_undone() %}
                            <form method="POST" action="{{ url_for('user.undo_transaction_route', transaction_id=transaction.id) }}" 
                                  onsubmit="return confirmUndo()" class="d-inline">
                                <button type="submit" class="undo-btn">
                                    <i class="fas fa-undo me-1"></i> Undo
                                </button>
                            </form>
                            {% else %}
                            <span class="text-muted small">Finalized</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="far fa-clock"></i>
            </div>
            <h4 class="text-muted mb-3">No transactions yet</h4>
            <p class="text-muted mb-4">Start by making your first deposit or transfer</p>
            <a href="{{ url_for('user.deposit') }}" class="btn-gradient-primary">
                <i class="fas fa-money-bill-wave me-2"></i> Make First Deposit
            </a>
        </div>
        {% endif %}
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Goals Summary -->
        <div class="goal-progress-card mb-4">
            <div class="position-relative z-1">
                <h4 class="mb-3"><i class="fas fa-bullseye me-2"></i> Financial Goals</h4>
                
                {% if active_goals %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-white opacity-90">Total Saved</span>
                            <span class="fw-bold">{{ format_currency(total_goals_saved) }}</span>
                        </div>
                        <div class="progress-bar-container">
                            {% set total_goal_percentage = (total_goals_saved / (active_goals|sum(attribute='target_amount') or 1)) * 100 %}
                            <div class="progress-bar" style="width: {{ total_goal_percentage|round|int }}%"></div>
                        </div>
                        <div class="text-center mt-2 small opacity-90">
                            {{ total_goal_percentage|round|int }}% of total goals
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="opacity-90">Active Goals</span>
                            <span class="fw-bold">{{ active_goals|length }}</span>
                        </div>
                        {% for goal in active_goals[:2] %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-truncate" style="max-width: 60%">{{ goal.goal_name }}</span>
                            <span class="fw-bold">{{ goal.progress_percentage()|round|int }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-bullseye fa-2x mb-3 opacity-50"></i>
                        <p class="mb-3">No active goals yet</p>
                    </div>
                {% endif %}
                
                <a href="{{ url_for('user.goals') }}" class="btn btn-light w-100">
                    <i class="fas fa-plus me-2"></i>
                    {% if active_goals %}Manage Goals{% else %}Create First Goal{% endif %}
                </a>
            </div>
        </div>
        
        <!-- Security Card -->
        <div class="security-card mb-4">
            <h5 class="mb-3"><i class="fas fa-shield-alt me-2"></i> Security & Safety</h5>
            <div class="mb-3">
                <div class="d-flex align-items-start mb-2">
                    <i class="fas fa-undo text-dark me-2 mt-1"></i>
                    <div>
                        <strong>{{ config.UNDO_MINUTES }}-Minute Undo</strong>
                        <p class="small mb-0">All transactions can be undone within {{ config.UNDO_MINUTES }} minutes for your safety</p>
                    </div>
                </div>
                <div class="d-flex align-items-start mb-2">
                    <i class="fas fa-lock text-dark me-2 mt-1"></i>
                    <div>
                        <strong>Bank-Level Security</strong>
                        <p class="small mb-0">All data is encrypted and protected</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-dark mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Demo Application:</strong> No real money is involved. This is a portfolio project.
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="glass-card p-3">
            <h6 class="mb-3"><i class="fas fa-chart-line me-2"></i> Quick Stats</h6>
            <div class="row">
                <div class="col-6">
                    <div class="text-center p-2">
                        <div class="text-primary fw-bold">{{ recent_transactions|length }}</div>
                        <div class="small text-muted">Recent Txns</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center p-2">
                        <div class="text-success fw-bold">{{ active_goals|length }}</div>
                        <div class="small text-muted">Active Goals</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="text-center p-2">
                        <div class="text-warning fw-bold">24/7</div>
                        <div class="small text-muted">Access</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center p-2">
                        <div class="text-purple fw-bold">100%</div>
                        <div class="small text-muted">Secure</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity Timeline -->
<div class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Banking Features</h3>
    </div>
    
    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="glass-card p-4 h-100">
                <div class="feature-icon-wrapper mb-3" style="background: var(--primary-gradient); width: 60px; height: 60px;">
                    <i class="fas fa-undo"></i>
                </div>
                <h5>Transaction Safety Net</h5>
                <p class="text-muted mb-0">All deposits, transfers, and payments can be undone within {{ config.UNDO_MINUTES }} minutes for peace of mind.</p>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="glass-card p-4 h-100">
                <div class="feature-icon-wrapper mb-3" style="background: var(--secondary-gradient); width: 60px; height: 60px;">
                    <i class="fas fa-bullseye"></i>
                </div>
                <h5>Smart Goal Tracking</h5>
                <p class="text-muted mb-0">Set, track, and achieve your financial goals with visual progress tracking and automated savings.</p>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="glass-card p-4 h-100">
                <div class="feature-icon-wrapper mb-3" style="background: var(--accent-gradient); width: 60px; height: 60px;">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <h5>Mobile-First Design</h5>
                <p class="text-muted mb-0">Bank seamlessly on any device. Our responsive design ensures perfect experience everywhere.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function confirmUndo() {
        return confirm('Are you sure you want to undo this transaction? This action cannot be reversed.');
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('.progress-bar');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0';
            setTimeout(() => {
                bar.style.width = width;
            }, 300);
        });
        
        const transactionCards = document.querySelectorAll('.transaction-card');
        transactionCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(5px)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
            });
        });
        
        const actionCards = document.querySelectorAll('.quick-action-card');
        actionCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                const icon = this.querySelector('.action-icon');
                if (icon) {
                    icon.style.transform = 'scale(1.1) rotate(5deg)';
                }
            });
            
            card.addEventListener('mouseleave', function() {
                const icon = this.querySelector('.action-icon');
                if (icon) {
                    icon.style.transform = 'scale(1) rotate(0)';
                }
            });
        });
        
        function updateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const timeString = now.toLocaleDateString('en-ZA', options);
            const timeElements = document.querySelectorAll('.current-time-display');
            timeElements.forEach(el => {
                el.textContent = timeString;
            });
        }
        
        updateTime();
        setInterval(updateTime, 60000);
    });
</script>
{% endblock %}